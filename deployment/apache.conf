# Apache Virtual Host Configuration for Inventory Management App (Windows)
# 
# This file provides a sample Apache virtual host configuration for the 
# Inventory Management Laravel application on Windows Server.
#
# Instructions:
# 1. Copy this content to your httpd-vhosts.conf file or include it
# 2. Update the paths and domain name to match your environment
# 3. Ensure mod_rewrite is enabled in httpd.conf
# 4. Restart Apache service
#
# Requirements:
# - Apache 2.4+
# - PHP 8.2+
# - mod_rewrite enabled
# - mod_ssl enabled (for HTTPS)
<VirtualHost *:443>
    # TLS Settings (adjust paths to your SSL certificates)
	ServerName inventory.museumwnf.org
	SSLEngine on
	SSLCertificateFile "conf/ssl.crt/server.crt"
	SSLCertificateKeyFile "conf/ssl.key/server.key"
	SSLCertificateChainFile "conf/ssl.crt/server-ca.crt"
	#SSLCACertificateFile "${SRVROOT}/conf/ssl.crt/ca-bundle.crt"
	
    # VHost settings
    ServerAdmin info@museumwnf.net
    DocumentRoot "C:/wwwroot/inventory-app/public"
	ErrorLog "logs/inventory.museumwnf.org.error.log"
	CustomLog "logs/inventory.museumwnf.org.access.log" combined
	DirectoryIndex index.php
	
	RewriteEngine On
	# LogLevel warn rewrite:trace3

	<FilesMatch "\.(php)$">
		SSLOptions +StdEnvVars
	</FilesMatch>
	BrowserMatch "MSIE [2-5]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
	
	# --------------------------------------------------------------------
	# BEGIN: Specific for the /cli SPA application (delete if not used)
	<Directory "C:/wwwroot/inventory-app/public/cli">
        AllowOverride All
        Require all granted
        Options -Indexes +FollowSymLinks	
		DirectoryIndex index.html
	</Directory>
	# END: Specific for the /cli SPA application (delete if not used)
    # --------------------------------------------------------------------

    # Laravel Main Directory configuration
	<Directory "C:/wwwroot/inventory-app/public">
        AllowOverride All
        Require all granted
        Options -Indexes +FollowSymLinks
		
		# --------------------------------------------------------------------
	    # BEGIN: Specific for the /cli SPA application (delete if not used)
        RewriteCond %{REQUEST_FILENAME} !-f
		RewriteRule ^cli/ index.php [QSA,L]
		
		RewriteRule ^cli$ index.php [QSA,L]
        # END: Specific for the /cli SPA application (delete if not used)
        # --------------------------------------------------------------------
		
		# Laravel URL rewriting
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php [QSA,L]
		
#		# Restrict access to Private IP addresses only
#		<RequireAny>
#			# See https://en.wikipedia.org/wiki/Private_network
#			# > Class A: Require ip 10.0.0.0/8
#			# > Class B: Require ip 172.16.0.0/12
#			# > Class C: Require ip 192.168.0.0/16
#			
#			# Client is on the VPN
#			Require ip 10.0.0.0/8
#			# Client is on one of the two MWNF servers
#			Require ip 192.168.255.157
#			Require ip 192.168.255.44
#			# Client is on this machine (equivalent to 192.168.255.157)
#			Require ip 127.0.0.1
#		</RequireAny>
    </Directory>
	
	# Security headers
	Header always set X-Content-Type-Options nosniff
	Header always set X-Frame-Options DENY
	Header always set X-XSS-Protection "1; mode=block"
	Header always set Referrer-Policy "strict-origin-when-cross-origin"
	Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
	# Hide PHP version
	Header unset X-Powered-By
	
	# Hide server information
	# ServerTokens Prod
	ServerSignature Off
	
	# PHP configuration for Windows
	<FilesMatch \.php$>
		SetHandler application/x-httpd-php
	</FilesMatch>
	
	# Cache static assets
	<LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
		# ExpiresActive On
		# ExpiresDefault "access plus 1 year"
		Header append Cache-Control "public, immutable"
	</LocationMatch>
	
	## Prevent access to sensitive files
	<Files ~ "^\.">
		Require all denied
	</Files>
	
	# --------------------------------------------------------------------
	# BEGIN: Specific for the /cli SPA application (delete if not used)
	<Files "version.json">
		Require all granted
	</Files>
	<Files "down.lock">
		Require all granted
	</Files>
    <FilesMatch "^(?!down\.lock$)(?!version\.json$).*\.(md|json|lock|yml|yaml|env)$">
        Require all denied
    </FilesMatch>
    # END: Specific for the /cli SPA application (delete if not used)
    # --------------------------------------------------------------------
	
    # --------------------------------------------------------------------
	# BEGIN: Specific when not using /cli SPA application (uncomment)
	#<FilesMatch "\.(md|json|lock|yml|yaml|env)$">
	#	Require all denied
	#</FilesMatch>
	# END: Specific when not using /cli SPA application (uncomment)
    # --------------------------------------------------------------------
	
	<DirectoryMatch "(storage|bootstrap/cache|vendor|node_modules)">
		Require all denied
	</DirectoryMatch>
	
	# Enable compression
	# LoadModule deflate_module modules/mod_deflate.so
	# <Location />
	#     SetOutputFilter DEFLATE
	#     SetEnvIfNoCase Request_URI \
	#         \.(?:gif|jpe?g|png)$ no-gzip dont-vary
	#     SetEnvIfNoCase Request_URI \
	#         \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
	# </Location>
	
</VirtualHost>
