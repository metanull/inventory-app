name: Manual Deployment (by TAG)

permissions:
  contents: read
  packages: read   # Need read permissions for GitHub Packages

on:
  
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to deploy (e.g., v1.0.0).'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: false
        default: 'MWNF-SVR'

jobs:
  deploy:
    name: Deploy to self-hosted Windows runner
    runs-on: [self-hosted, windows]
    environment: 
      name: ${{ github.event.inputs.environment || 'MWNF-SVR' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          clean: true

      - name: Download tag archive
        id: download
        run: |
          $url = "https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.inputs.tag }}.zip"
          $workspace = Join-Path "$env:TEMP" "deploy-${{ github.run_id }}-${{ github.event.inputs.tag }}"
          $repoName = Split-Path -Leaf "${{ github.repository }}"
          $zipName = "$repoName-${{ github.event.inputs.tag }}.zip"
          $zipPath = Join-Path $workspace $zipName
          
          New-Item -Path $workspace -ItemType Directory -Force -ErrorAction Stop | Out-Null
          
          Write-Host "Downloading $url to $zipPath"
          Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing -ErrorAction Stop

          Write-Output "packagePath=$zipPath" >> $env:GITHUB_OUTPUT
          Write-Output "workdir=$workspace" >> $env:GITHUB_OUTPUT

      - name: Deploy with Deploy-Application.ps1
        shell: pwsh
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          APP_NAME: ${{ secrets.APP_NAME }}
          DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
          DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          WEBSERVER_PATH_PROD: ${{ secrets.WEBSERVER_PATH_PROD }}
          SHARED_STORAGE_ROOT: ${{ secrets.SHARED_STORAGE_ROOT }}
          PHP_PATH: ${{ secrets.PHP_PATH }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $package = '${{ steps.download.outputs.packagePath }}'
          $log = Join-Path '${{ steps.download.outputs.workdir }}' 'deploy.log'

          $ErrorActionPreference = 'Stop'
          Add-Content -Path $log -Value "Starting deployment: $(Get-Date -Format o)"

          Add-Content -Path $log -Value "Securing database password..."
          $dbCred = New-Object System.Management.Automation.PSCredential(
            $env:DATABASE_USERNAME, 
            (ConvertTo-SecureString -String $env:DATABASE_PASSWORD -AsPlainText -Force)
          )

          Add-Content -Path $log -Value "Deploying application..."
          .\scripts\Deploy-Application.ps1 `
            -DeploymentPackagePath $package `
            -WebserverPath $env:WEBSERVER_PATH_PROD `
            -SharedStorageRoot $env:SHARED_STORAGE_ROOT `
            -PhpPath $env:PHP_PATH `
            -AppUrl $env:APP_URL `
            -AppName $env:APP_NAME `
            -AppEnv 'production' `
            -AppKey $env:APP_KEY `
            -DatabaseHost $env:DATABASE_HOST `
            -DatabasePort ([int]$env:DATABASE_PORT) `
            -DatabaseName $env:DATABASE_NAME `
            -DatabaseCredential $dbCred `
            -Verbose *>&1 | Tee-Object -FilePath $log -Append

          Add-Content -Path $log -Value "Deployment finished: $(Get-Date -Format o)"

      - name: Upload deploy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log-${{ github.run_id }}
          path: ${{ steps.download.outputs.workdir }}/deploy.log

