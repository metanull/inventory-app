name: Publish API Client

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: ["main"]
    paths:
      - 'app/**'
      - 'routes/api.php'
      - 'config/scramble.php'

concurrency:
  group: publish-api-client-${{ github.ref }}
  cancel-in-progress: true

jobs:
  
  build-openapi-spec:
    name: Build OpenAPI Specification
    runs-on: ubuntu-latest
    
    outputs:
      is_github: ${{ steps.env.outputs.is_github }}
      is_act: ${{ steps.env.outputs.is_act }}
    
    env:
      DB_CONNECTION: sqlite
      DB_DATABASE: ':memory:'

    steps:
      - name: "Setup > Checkout Repository"
        uses: actions/checkout@v5

      - name: "Check > Detect environment"
        id: env
        uses: ./.github/actions/detect-environment

      - name: "Build > Generate OpenAPI specification"
        uses: ./.github/actions/generate-openapi-spec

      - name: "Artifact > Upload OpenAPI spec"
        if: steps.env.outputs.is_github == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: docs/_openapi/api.json
          retention-days: 1
          if-no-files-found: error

  build-api-client:
    name: Build API Client Package
    runs-on: ubuntu-latest
    needs: build-openapi-spec
    
    outputs:
      has-changes: ${{ steps.generate-client.outputs.has-changes }}
      
    steps:
      - name: "Setup > Checkout Repository"
        uses: actions/checkout@v5

      - name: "Check > Detect environment"
        id: env
        uses: ./.github/actions/detect-environment

      - name: "Setup > Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'

      - name: "Setup > Java"
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: "Artifact > Download OpenAPI spec"
        if: steps.env.outputs.is_github == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: docs/_openapi

      - name: "Fallback > Generate OpenAPI spec (act only)"
        if: steps.env.outputs.is_act == 'true'
        uses: ./.github/actions/generate-openapi-spec

      - name: "Build > API Client > Generate"
        id: generate-client
        uses: ./.github/actions/generate-api-client
        with:
          openapi_spec_path: 'docs/_openapi/api.json'

      - name: "Artifact > Upload API Client"
        if: steps.generate-client.outputs.has-changes == 'true' && steps.env.outputs.is_github == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-client
          path: api-client/
          retention-days: 1
          if-no-files-found: error

  publish-api-client:
    name: Publish API Client to GitHub Packages
    runs-on: ubuntu-latest
    needs: [build-api-client, build-openapi-spec]
    # Only run on GitHub and when there are changes
    if: needs.build-api-client.outputs.has-changes == 'true' && needs.build-openapi-spec.outputs.is_github == 'true'
    
    steps:
      - name: "Setup > Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'

      - name: "Artifact > Download API Client"
        uses: actions/download-artifact@v4
        with:
          name: api-client
          path: api-client

      - name: "Publish > API Client"
        uses: ./.github/actions/publish-npm-package
        with:
          package_directory: 'api-client'
          registry: 'https://npm.pkg.github.com/'
          token: ${{ secrets.GH_PACKAGE_TOKEN }}
