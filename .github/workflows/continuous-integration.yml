name: Continuous Integration

permissions:
  contents: write  # Need write permissions for version bump
  pull-requests: write
  packages: read   # Need read permissions for GitHub Packages

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

  workflow_dispatch:
    # Allow manual triggering

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  
  backend-lint:
    name: Backend Linting and Validation
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v5

      - name: "Setup > Image > Install php"
        uses: shivammathur/setup-php@v2
        with:
          # php-version: '8.2'  # If not specified, setup-php will use the version defined in composer.lock
          extensions: fileinfo, zip, sqlite3, pdo_sqlite, gd, exif
          tools: pint

      - name: "Check > Composer > Check requirements"
        run: |
          composer check-platform-reqs

      - name: "Check > Composer > Validate composer.json"
        run: |
          composer validate --with-dependencies --strict

      - name: "Setup > Composer > Install Dependencies"
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: "Setup > Composer > Check Vulnerabilities"
        run: |
          composer audit --format=summary

      - name: "Setup > Laravel > Create .env file from example"
        run: |
          if(-not(Test-Path ".env.local.example")) {
            throw "No .env.local.example file found!"
          }
          if(-not(Test-Path ".env")) {
            Copy-Item .env.local.example .env -ErrorAction Stop
          }

      - name: "Setup > Laravel > Generate application key"
        run: |
          php artisan key:generate

      - name: "Setup > Laravel > Create database"
        run: |
          php artisan migrate --force

      - name: "Setup > Laravel > Validate migrations"
        run: |
          php artisan migrate:rollback
          php artisan migrate

      - name: "Check > Laravel > Linting"
        run: |
          ./vendor/bin/pint --bail

  backend-tests:
    name: Backend Tests (${{ matrix.suite }})
    runs-on: windows-latest
    
    strategy:
      fail-fast: true  # Stop running other suites as soon as one fails
      matrix:
        suite:
          - Unit
          - Api
          - Web
          - Configuration
          - Console
          - Event
          - Integration

    steps:
      - uses: actions/checkout@v5

      - name: "Setup > Image > Install php"
        uses: shivammathur/setup-php@v2
        with:
          # php-version: '8.2'  # If not specified, setup-php will use the version defined in composer.lock
          extensions: fileinfo, zip, sqlite3, pdo_sqlite, gd, exif
          coverage: xdebug
          tools: phpunit, pest

      - name: "Setup > Composer > Install Dependencies"
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: "Setup > Laravel > Create .env file from example"
        run: |
          if(-not(Test-Path ".env.local.example")) {
            throw "No .env.local.example file found!"
          }
          if(-not(Test-Path ".env")) {
            Copy-Item .env.local.example .env -ErrorAction Stop
          }

      - name: "Setup > Laravel > Generate application key"
        run: |
          php artisan key:generate

      - name: "Setup > Laravel > Create database"
        run: |
          php artisan migrate --force

      - name: "Check > Laravel > Run ${{ matrix.suite }} Tests"
        env:
          DB_CONNECTION: sqlite
        run: |
          php artisan test --testsuite=${{ matrix.suite }} --coverage --parallel --no-ansi --stop-on-failure

  backend-frontend-validation:
    name: Backend Frontend Validation (Blade/Tailwind)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v5

      - name: "Setup > Image > Install Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: "22.17.0"
          registry-url: https://npm.pkg.github.com/

      - name: "Setup > npm > Install Dependencies (Root)"
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          npm ci --no-audit --no-fund

      - name: "Check > npm > Check Vulnerabilities (Root)"
        run: |
          npm audit --audit-level moderate

      - name: "Check > npm > Build Backend Assets"
        run: |
          npm run build

  spa-frontend-validation:
    name: Frontend Validation - SPA (Vue 3)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v5

      - name: "Setup > Image > Install Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: "22.17.0"
          registry-url: https://npm.pkg.github.com/

      - name: "Setup > npm > Install Dependencies (SPA)"
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        working-directory: spa
        run: |
          npm ci --no-audit --no-fund

      - name: "Check > npm > Check Vulnerabilities (SPA)"
        working-directory: spa
        run: |
          npm audit --audit-level moderate

      - name: "Check > npm > Build SPA"
        working-directory: spa
        run: |
          npm run build

      - name: "Check > npm > Linting (SPA)"
        working-directory: spa
        run: |
          npm run lint

      - name: "Check > npm > Run Tests (SPA)"
        working-directory: spa
        run: |
          npm run test:all

  ci-success:
    name: CI Success
    runs-on: windows-latest
    needs: [backend-lint, backend-tests, backend-frontend-validation, spa-frontend-validation]
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          $backendLintResult = "${{ needs.backend-lint.result }}"
          $backendTestsResult = "${{ needs.backend-tests.result }}"
          $backendFrontendResult = "${{ needs.backend-frontend-validation.result }}"
          $spaFrontendResult = "${{ needs.spa-frontend-validation.result }}"
          
          if ($backendLintResult -ne "success" -or $backendTestsResult -ne "success" -or $backendFrontendResult -ne "success" -or $spaFrontendResult -ne "success") {
            Write-Output "One or more validation jobs failed"
            Write-Output "Backend Lint: $backendLintResult"
            Write-Output "Backend Tests: $backendTestsResult"
            Write-Output "Backend Frontend: $backendFrontendResult"
            Write-Output "SPA Frontend: $spaFrontendResult"
            exit 1
          }
