name: Continuous Deployment

permissions:
  contents: read
  packages: read   # Need read permissions for GitHub Packages

on:
  push:
    branches: ["main"]
  
  workflow_dispatch:
    
jobs:
  deploy:
    name: Deploy to self-hosted Windows runner
    runs-on: [self-hosted, windows]
    environment: 
      name: MWNF-SVR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          clean: true

      - name: Deploy with Deploy-Application.ps1
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          APP_NAME: ${{ secrets.APP_NAME }}
          DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
          DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          WEBSERVER_PATH_PROD: ${{ secrets.WEBSERVER_PATH_PROD }}
          SHARED_STORAGE_ROOT: ${{ secrets.SHARED_STORAGE_ROOT }}
          PHP_PATH: ${{ secrets.PHP_PATH }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $directory = Resolve-Path '.' | Select-Object -ExpandProperty Path
          $log = Join-Path $directory 'deploy.log'

          $ErrorActionPreference = 'Stop'
          Add-Content -Path $log -Value "Starting deployment: $(Get-Date -Format o)"

          Add-Content -Path $log -Value "Securing database password..."
          $dbCred = New-Object System.Management.Automation.PSCredential(
            $env:DATABASE_USERNAME, 
            (ConvertTo-SecureString -String $env:DATABASE_PASSWORD -AsPlainText -Force)
          )

          Add-Content -Path $log -Value "Deploying application..."
          .\scripts\Deploy-Application.ps1 `
            -DeploymentPackagePath $directory `
            -WebserverPath $env:WEBSERVER_PATH_PROD `
            -SharedStorageRoot $env:SHARED_STORAGE_ROOT `
            -PhpPath $env:PHP_PATH `
            -AppUrl $env:APP_URL `
            -AppName $env:APP_NAME `
            -AppEnv 'production' `
            -AppKey $env:APP_KEY `
            -DatabaseHost $env:DATABASE_HOST `
            -DatabasePort ([int]$env:DATABASE_PORT) `
            -DatabaseName $env:DATABASE_NAME `
            -DatabaseCredential $dbCred `
            -Verbose *>&1 | Tee-Object -FilePath $log -Append

          Add-Content -Path $log -Value "Deployment finished: $(Get-Date -Format o)"

      - name: Upload deploy log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-log-${{ github.run_id }}
          path: ${{ steps.download.outputs.workdir }}/deploy.log

